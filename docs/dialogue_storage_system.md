# 对话存储与上下文管理系统

## 系统概述

对话存储与上下文管理系统是彩虹城AI Agent的核心组件，它负责在用户与AI对话过程中自动存储对话内容，并能够利用历史记录来增强AI响应。系统不仅提供基础的对话存储功能，还包括智能上下文管理、语义索引和用户画像构建等高级功能。

## 系统目标

- **无缝存储对话**：在用户与AI交互时自动保存所有对话内容
- **上下文感知**：AI能够理解并利用之前的对话历史
- **智能检索**：能够根据当前对话主题智能检索相关的历史对话
- **长期记忆**：保持对用户偏好、习惯和重要信息的长期记忆

## 系统架构

### 后端组件

1. **对话存储层**
   - 使用SurrealDB存储完整的对话内容
   - 每个对话轮次包含详细的元数据（时间戳、情感分析、主题标签等）
   - 支持高效的检索和查询

2. **上下文管理器**
   - 维护当前对话的上下文窗口
   - 智能决定哪些历史信息应该包含在当前上下文中
   - 处理上下文长度限制，确保最相关的信息被保留

3. **语义索引系统**
   - 对对话内容进行向量化处理
   - 构建语义索引，支持相似性搜索
   - 能够找到与当前对话语义相关的历史对话片段

4. **用户画像系统**
   - 构建和维护用户的长期画像
   - 记录用户偏好、习惯、常见问题等
   - 为AI提供个性化响应的基础

### 前端组件

1. **无感知存储界面**
   - 用户无需手动保存对话
   - 自动在后台进行对话存储和上下文管理
   - 提供简洁的历史查看功能

2. **上下文感知指示器**
   - 可视化显示AI当前使用的上下文范围
   - 让用户了解AI"记住"了多少历史对话

## 实现路径

### 第一阶段：基础存储系统（当前阶段）

- 完善SurrealDB的会话和轮次存储
- 实现基本的对话历史记录功能
- 前端实现无感知的会话管理

### 第二阶段：上下文管理

- 实现上下文管理器
- 添加智能上下文选择算法
- 优化AI响应生成过程，考虑历史上下文

### 第三阶段：语义索引和用户画像

- 实现语义索引系统
- 添加用户画像构建和维护
- 优化相关历史检索算法

### 第四阶段：高级功能

- 添加对话摘要自动生成
- 实现主题标签自动提取
- 添加情感分析和意图识别

## 数据模型

### 会话模型

```json
{
    "id": "session_id",
    "user_id": "user_id",
    "title": "对话标题",
    "created_at": "time::now()",
    "updated_at": "time::now()",
    "last_activity_at": "time::now()",
    "summary": "对话摘要，由AI自动生成",
    "topics": ["主题1", "主题2"],
    "sentiment": "积极/中性/消极",
    "metadata": {
        "user_location": "用户位置",
        "device_info": "设备信息",
        "session_duration": "会话持续时间"
    }
}
```

### 轮次模型

```json
{
    "id": "turn_id",
    "session_id": "session_id",
    "role": "user/assistant",
    "content": "消息内容",
    "created_at": "time::now()",
    "embedding": [0.1, 0.2, ...],
    "metadata": {
        "sentiment": "情感分析结果",
        "entities": ["实体1", "实体2"],
        "intent": "用户意图",
        "importance_score": 0.85,
        "topics": ["主题1", "主题2"]
    }
}
```

### 用户画像模型

```json
{
    "id": "user_id",
    "created_at": "time::now()",
    "updated_at": "time::now()",
    "preferences": {
        "topics_of_interest": ["兴趣1", "兴趣2"],
        "communication_style": "偏好的沟通风格",
        "response_length": "偏好的回复长度"
    },
    "facts": [
        {"fact": "用户提到的事实1", "confidence": 0.9, "last_mentioned": "时间戳"},
        {"fact": "用户提到的事实2", "confidence": 0.7, "last_mentioned": "时间戳"}
    ],
    "frequently_asked_topics": [
        {"topic": "常问主题1", "count": 5, "last_asked": "时间戳"},
        {"topic": "常问主题2", "count": 3, "last_asked": "时间戳"}
    ],
    "metadata": {
        "total_sessions": 10,
        "total_messages": 150,
        "average_session_length": 15
    }
}
```

## 当前进度

### 第一阶段：基础存储系统（进行中）

- [x] 完善SurrealDB集成
- [ ] 优化会话和轮次存储模型
- [ ] 实现基本的对话历史记录功能
- [ ] 前端实现无感知的会话管理

## 下一步计划

1. 优化会话和轮次存储模型，添加必要的元数据字段
2. 实现基本的对话历史记录功能
3. 前端实现无感知的会话管理
